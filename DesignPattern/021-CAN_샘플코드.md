# CAN Sample

## ğŸ¯ ì í•©í•œ ë””ìì¸ íŒ¨í„´
| ë””ìì¸ íŒ¨í„´             | ì ìš© ì´ìœ  ë° ì—­í•  ì„¤ëª…                                               |
|------------------------|---------------------------------------------------------------------|
| Observer               | ì„¼ì„œë“¤ì´ ì¤‘ì•™ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³ , ìƒíƒœ ë³€í™”ì— ë”°ë¼ ë°˜ì‘í•¨ (êµ¬ë…ì ëª¨ë¸)     |
| Mediator               | ì„¼ì„œ ê°„ ì§ì ‘ ì—°ê²° ì—†ì´ ì¤‘ì•™ í†µì œ ì¥ì¹˜(CAN ë²„ìŠ¤)ê°€ ë©”ì‹œì§€ë¥¼ ì¤‘ì¬í•¨         |
| State                  | ì„¼ì„œê°€ ê³ ì¥ ìƒíƒœë¡œ ì „í™˜ë˜ë©´ ë™ì‘ ë°©ì‹ì´ ë°”ë€œ (ì˜ˆ: ì†¡ì‹  ì°¨ë‹¨, ë¬´ì‹œ ë“±)     |
| Strategy               | ì„¼ì„œë§ˆë‹¤ ê³ ì¥ ëŒ€ì‘ ë°©ì‹ì´ ë‹¤ë¥¼ ê²½ìš°, ì „ëµì„ ë°”ê¿”ì„œ í–‰ë™ì„ ê²°ì •í•¨           |
| Chain of Responsibility| ë©”ì‹œì§€ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì „ë‹¬í•˜ë©°, ê° ì„¼ì„œê°€ ì¡°ê±´ì— ë”°ë¼ ì²˜ë¦¬í•˜ê±°ë‚˜ ë¬´ì‹œí•¨     |
| Command                | ì„¼ì„œê°€ ìˆ˜í–‰í•  ë™ì‘ì„ ìº¡ìŠí™”í•˜ì—¬ ì¤‘ì•™ì—ì„œ ëª…ë ¹ì„ ë°œí–‰í•˜ê³  ì‹¤í–‰í•¨           |


## ğŸ§  êµ¬ì¡°ì ìœ¼ë¡œ ë³´ë©´
- ì„¼ì„œë“¤ì€ Observer: ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³ , ìì‹ ì˜ ìƒíƒœì— ë”°ë¼ ë°˜ì‘
- CAN ë²„ìŠ¤ëŠ” Mediator: ì„¼ì„œ ê°„ ì§ì ‘ ì—°ê²° ì—†ì´ ë©”ì‹œì§€ë¥¼ ì¤‘ì¬
- ì„¼ì„œì˜ ê³ ì¥ ìƒíƒœëŠ” State: ê³ ì¥ë‚˜ë©´ ì†¡ì‹  ì°¨ë‹¨, ìˆ˜ì‹  ë¬´ì‹œ ë“± ìƒíƒœ ê¸°ë°˜ ë™ì‘
- ì„¼ì„œì˜ ë°˜ì‘ ë°©ì‹ì€ Strategy: ì˜ˆë¥¼ ë“¤ì–´, ì˜¨ë„ ì„¼ì„œëŠ” ê²½ê³ ë§Œ, ë¸Œë ˆì´í¬ ì„¼ì„œëŠ” ì¦‰ì‹œ ì‘ë™ ì¤‘ì§€

## ğŸ§© Mermaid ë‹¤ì´ì–´ê·¸ë¨ ì˜ˆì‹œ
```mermaid
classDiagram
    class CANBus {
        +broadcast(message)
        +register(sensor)
    }

    class Sensor {
        <<abstract>>
        +receive(message)
        +send()
        +change_state()
    }

    class TemperatureSensor {
        +receive(message)
        +send()
    }

    class BrakeSensor {
        +receive(message)
        +send()
    }

    class SensorState {
        <<interface>>
        +handle_message()
    }

    class NormalState
    class FaultState

    Sensor --> SensorState
    SensorState <|.. NormalState
    SensorState <|.. FaultState
    CANBus --> Sensor : observers
    TemperatureSensor --> Sensor
    BrakeSensor --> Sensor
```


## âœ… Rust ìŠ¤íƒ€ì¼ë¡œ êµ¬ì„±í•˜ë©´
- Sensor trait: receive(), send(), change_state()
- CANBus: ì„¼ì„œë“¤ì„ ë“±ë¡í•˜ê³  broadcast()
- SensorState: Normal, Fault ìƒíƒœë¡œ ë‚˜ëˆ ì„œ ë™ì‘ ì œì–´
- ê° ì„¼ì„œëŠ” Box<dyn Sensor>ë¡œ ê´€ë¦¬í•˜ë©°, ìƒíƒœì— ë”°ë¼ ë™ì‘ ë³€ê²½

## ğŸ¦€ Rust ì½”ë“œ ì˜ˆì œ
```rust
use std::collections::HashMap;

// ì„¼ì„œ ìƒíƒœ
#[derive(Debug, Clone, PartialEq)]
enum SensorState {
    Normal,
    Faulty,
}

// ì„¼ì„œ trait
trait Sensor {
    fn id(&self) -> String;
    fn get_state(&self) -> SensorState;
    fn report(&self, controller: &mut CentralController);
    fn receive(&mut self, message: &str);
}

// ë¸Œë ˆì´í¬ ì„¼ì„œ
struct BrakeSensor {
    state: SensorState,
}

impl BrakeSensor {
    fn new() -> Self {
        Self {
            state: SensorState::Normal,
        }
    }

    fn fail(&mut self) {
        self.state = SensorState::Faulty;
    }
}

impl Sensor for BrakeSensor {
    fn id(&self) -> String {
        "BrakeSensor".to_string()
    }

    fn get_state(&self) -> SensorState {
        self.state.clone()
    }

    fn report(&self, controller: &mut CentralController) {
        controller.receive_report(self.id(), self.get_state());
    }

    fn receive(&mut self, message: &str) {
        if self.state == SensorState::Faulty {
            println!("{}: Faulty. Ignoring message.", self.id());
        } else {
            println!("{} received: {}", self.id(), message);
        }
    }
}

// ì¡°í–¥ ì¶• ì„¼ì„œ
struct SteeringSensor {
    state: SensorState,
}

impl SteeringSensor {
    fn new() -> Self {
        Self {
            state: SensorState::Normal,
        }
    }

    fn fail(&mut self) {
        self.state = SensorState::Faulty;
    }
}

impl Sensor for SteeringSensor {
    fn id(&self) -> String {
        "SteeringSensor".to_string()
    }

    fn get_state(&self) -> SensorState {
        self.state.clone()
    }

    fn report(&self, controller: &mut CentralController) {
        controller.receive_report(self.id(), self.get_state());
    }

    fn receive(&mut self, message: &str) {
        if self.state == SensorState::Faulty {
            println!("{}: Faulty. Ignoring message.", self.id());
        } else {
            println!("{} received: {}", self.id(), message);
        }
    }
}

// ì¤‘ì•™ í†µì œ ì¥ì¹˜
struct CentralController {
    sensor_states: HashMap<String, SensorState>,
    user_info: String,
}

impl CentralController {
    fn new(user_info: &str) -> Self {
        Self {
            sensor_states: HashMap::new(),
            user_info: user_info.to_string(),
        }
    }

    fn receive_report(&mut self, sensor_id: String, state: SensorState) {
        println!("Controller received report from {}: {:?}", sensor_id, state);
        self.sensor_states.insert(sensor_id, state);
    }

    fn broadcast(&self, message: &str, sensors: &mut Vec<Box<dyn Sensor>>) {
        println!("Controller broadcasting: {}", message);
        for sensor in sensors.iter_mut() {
            sensor.receive(message);
        }
    }

    fn show_status(&self) {
        println!("--- Sensor Status ---");
        for (id, state) in &self.sensor_states {
            println!("{}: {:?}", id, state);
        }
    }
}

// ë©”ì¸ ì‹œë®¬ë ˆì´ì…˜
fn main() {
    let mut controller = CentralController::new("User: JungHwan");

    let mut brake = Box::new(BrakeSensor::new());
    let mut steering = Box::new(SteeringSensor::new());

    let mut sensors: Vec<Box<dyn Sensor>> = vec![brake, steering];

    // ì´ˆê¸° ìƒíƒœ ë³´ê³ 
    for sensor in sensors.iter() {
        sensor.report(&mut controller);
    }

    controller.broadcast("System Check", &mut sensors);

    // ë¸Œë ˆì´í¬ ì„¼ì„œ ê³ ì¥
    sensors[0].as_mut().receive("Brake failure detected");
    sensors[0].as_mut().report(&mut controller);
    sensors[0].as_mut().receive("Emergency Stop");

    // ì¡°í–¥ ì„¼ì„œ ì •ìƒ ë™ì‘
    sensors[1].as_mut().receive("Steering calibration");

    controller.show_status();
}
```


## âœ… ì£¼ìš” ë™ì‘ íë¦„
| êµ¬ì„± ìš”ì†Œ           | ì£¼ìš” ë™ì‘ ì„¤ëª…                                      |
|--------------------|-----------------------------------------------------|
| `Sensor`           | ê³µí†µ ì¸í„°í˜ì´ìŠ¤: `report()`ë¡œ ìƒíƒœ ë³´ê³ , `receive()`ë¡œ ë©”ì‹œì§€ ìˆ˜ì‹  |
| `BrakeSensor`      | ê³ ì¥ ì‹œ ë©”ì‹œì§€ ë¬´ì‹œ, ìƒíƒœ ë³´ê³  ìˆ˜í–‰                  |
| `SteeringSensor`   | ì •ìƒ ìƒíƒœì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ë° ë°˜ì‘                    |
| `CentralController`| ì„¼ì„œ ìƒíƒœ ìˆ˜ì§‘, ì‚¬ìš©ì ì •ë³´ ë³´ìœ , ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| `main()`           | ì„¼ì„œ ì´ˆê¸°í™”, ìƒíƒœ ë³´ê³ , ê³ ì¥ ì‹œë®¬ë ˆì´ì…˜, ì „ì²´ íë¦„ ì‹¤í–‰ |


ğŸ§© Mermaid í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
```mermaid
classDiagram
    class Sensor {
        <<trait>>
        +id()
        +get_state()
        +report(controller)
        +receive(message)
    }

    class BrakeSensor {
        +fail()
    }

    class SteeringSensor {
        +fail()
    }

    class CentralController {
        +receive_report()
        +broadcast()
        +show_status()
    }

    Sensor <|.. BrakeSensor
    Sensor <|.. SteeringSensor
    CentralController --> Sensor : manages
```


---


## ğŸ¦€ Rust ìŠ¤íƒ€ì¼ êµ¬ì¡° (RTOS ì‹œë®¬ë ˆì´ì…˜ ê¸°ë°˜)
Rustì—ì„œëŠ” RTOSë¥¼ ì§ì ‘ ì“°ê¸°ë³´ë‹¤ëŠ” async ê¸°ë°˜ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìˆì–´ìš”:
```rust
use std::collections::HashMap;

trait Observer {
    fn notify(&self, sensor_id: &str, state: SensorState);
}

#[derive(Debug, Clone, PartialEq)]
enum SensorState {
    Normal,
    Faulty,
}

trait Sensor {
    fn id(&self) -> String;
    fn check_state(&self) -> SensorState;
    fn register(&mut self, controller: Box<dyn Observer>);
    fn deregister(&mut self);
    fn run(&mut self); // RTOS íƒœìŠ¤í¬ì²˜ëŸ¼ ì£¼ê¸°ì  ì‹¤í–‰
}

struct CentralController {
    sensor_states: HashMap<String, SensorState>,
}

impl CentralController {
    fn new() -> Self {
        Self {
            sensor_states: HashMap::new(),
        }
    }

    fn show_status(&self) {
        println!("--- Sensor Status ---");
        for (id, state) in &self.sensor_states {
            println!("{}: {:?}", id, state);
        }
    }
}

impl Observer for CentralController {
    fn notify(&self, sensor_id: &str, state: SensorState) {
        println!("Controller received: {} is {:?}", sensor_id, state);
        // ì‹¤ì‹œê°„ ì²˜ë¦¬ ë¡œì§ ì‚½ì… ê°€ëŠ¥
    }
}
```

ì‹¤ì œ RTOSì—ì„œëŠ” Sensor::run()ì´ ê° íƒœìŠ¤í¬ë¡œ ë¶„ë¦¬ë˜ê³ ,
notify()ëŠ” ë©”ì‹œì§€ í ë˜ëŠ” ì´ë²¤íŠ¸ í”Œë˜ê·¸ë¡œ êµ¬í˜„ë©ë‹ˆë‹¤.


## ğŸ§© Mermaid êµ¬ì¡°ë„
```mermaid
classDiagram
    class Sensor {
        <<trait>>
        +check_state()
        +register(controller)
        +deregister()
        +run()
    }

    class BrakeSensor
    class SteeringSensor

    class Observer {
        <<trait>>
        +notify(sensor_id, state)
    }

    class CentralController {
        +notify()
        +show_status()
    }

    Sensor <|.. BrakeSensor
    Sensor <|.. SteeringSensor
    Observer <|.. CentralController
    Sensor --> Observer : notify()
```


## ğŸ’¡ RTOSì—ì„œì˜ í™•ì¥ í¬ì¸íŠ¸
- SensorManager íƒœìŠ¤í¬: ì„¼ì„œ ë“±ë¡/ì œê±° ê´€ë¦¬
- FaultHandler: ê³ ì¥ ê°ì§€ ì‹œ ìë™ ëŒ€ì‘ (ì˜ˆ: fail-safe ëª¨ë“œ ì§„ì…)
- TelemetryLogger: ìƒíƒœ ë³€í™” ë¡œê·¸ ê¸°ë¡ ë° ì™¸ë¶€ ì „ì†¡
- Priority Scheduler: ì„¼ì„œë³„ ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ìŠ¤ì¼€ì¤„ë§
---
