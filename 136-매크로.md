# 매크로
Rust의 매크로는 단순한 코드 치환을 넘어서 컴파일 타임에 코드 생성과 제어를 가능하게 하는 강력한 도구.


## 🧠 매크로란?
- 컴파일 타임에 코드 생성을 수행하는 기능
- 반복되는 패턴을 줄이고, 다양한 입력을 처리하며, 런타임 비용 없이 코드 확장 가능
- 함수와 달리 ! 기호를 사용하며, 런타임이 아닌 컴파일 타임에 실행됨
예: println!, vec!, assert_eq! 등은 모두 매크로

## 🧩 매크로의 종류
| 종류       | 예시 또는 설명                                |
|------------------------|-----------------------------------------------|
| `macro_rules!`         | 선언적 매크로. 패턴 기반 코드 생성             |
| `#[derive]` 매크로     | `#[derive(Debug)]`, `#[derive(Clone)]` 등 자동 trait 구현 |
| 속성(attribute) 매크로 | `#[test]`, `#[route]`, `#[tokio::main]` 등 함수/타입에 부가 동작 부여 |
| 함수(proc macro) 매크로| `my_macro!(...)` 형태. 사용자 정의 구문 처리 가능 |


## 🛠 macro_rules! 사용법
```rust
#[macro_export]
macro_rules! say_hello {
    () => {
        println!("Hello from macro!");
    };
}
```

- #[macro_export]를 붙이면 크레이트 루트에 등록되어 외부에서도 사용 가능
- 다양한 패턴을 정의해 입력에 따라 다른 코드를 생성 가능

## 🧪 프로시저 매크로 예시
```rust
// lib.rs
use proc_macro::TokenStream;

#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    // 입력된 구조체를 분석하고 trait 구현 코드를 생성
}
```

- proc_macro 크레이트 필요
- syn, quote 라이브러리로 AST 파싱 및 코드 생성

## ⚠️ 매크로 사용 시 주의점
| 항목     | 설명                                                                 |
|-----------------------------|----------------------------------------------------------------------|
| 디버깅 어려움                | 매크로는 컴파일 타임에 확장되므로 에러 위치 추적이 어려울 수 있음       |
| 이름 충돌 위험               | 전역 네임스페이스에 등록되므로 동일 이름의 매크로가 충돌할 수 있음       |
| 가독성 저하 가능             | 과도한 매크로 사용은 코드 흐름을 불명확하게 만들 수 있음                |
| `#[macro_export]`의 범위     | 루트 스코프에 등록되므로 모듈 경로와 무관하게 전역에서 접근됨            |
| `Copy`와 `Drop`은 양립 불가  | `Drop`을 구현한 타입은 `Copy`를 붙일 수 없음 → 매크로로 생성된 타입도 주의 필요 |



## ✨ 언제 매크로를 쓰면 좋은가?
- 반복되는 코드 패턴을 줄이고 싶을 때
- 다양한 입력을 유연하게 처리하고 싶을 때
- trait 구현, 테스트, 라우팅 등 코드 자동 생성이 필요할 때
- 런타임 비용 없이 컴파일 타임에 코드 확장이 필요할 때

## 📦 매크로 관리 팁
| 전략           | 설명                                                                 |
|-----------------------------|----------------------------------------------------------------------|
| `macros.rs`                 | 공통 매크로를 한 파일에 모아두면 유지보수와 재사용에 유리함             |
| `#[macro_export]`           | 매크로를 크레이트 루트에 등록하여 외부에서도 사용할 수 있게 함          |
| 이름에 prefix 붙이기        | `math_approx_f64!`, `util_log!` 등으로 이름 충돌 방지                  |
| 내부 전용은 export 생략     | `macro_rules!`만 사용하고 `pub(crate)` 수준에서 제한하면 안전하게 관리 가능 |


---

# 매크로 선언

 외부 크레이트에서 macro_rules! 매크로를 사용하려면 정확한 위치에 선언과 설정이 필요.
 
## ✅ 1. 매크로 정의 크레이트에서 매크로를 사용하려면
| 위치 | 설명                                                              |
|------------------------------|-------------------------------------------------------------------|
| `macros.rs` 또는 `macros/mod.rs` | `macro_rules!`로 매크로 정의하고 `#[macro_export]`를 붙여야 루트에 등록됨 |
| `lib.rs`                     | `mod macros;` 선언을 통해 매크로 모듈을 루트에 포함시켜야 외부에서 접근 가능 |

```rust
// lib.rs
mod macros; // 루트에 등록해야 #[macro_export]가 작동함
```

```rust
// macros.rs
#[macro_export]
macro_rules! approx_f64 {
    ($a:expr, $b:expr, $eps:expr) => {
        (($a as f64) - ($b as f64)).abs() <= ($eps as f64)
    };
}
```

## ✅ 2. 외부 크레이트에서
|    위치    | 설명                                                              |
|------------------------------|-------------------------------------------------------------------|
| `Cargo.toml`                 | 매크로 정의 크레이트를 `dependencies`에 추가                       |
| 코드 상단                    | `use crate_name::macro_name;` 방식으로 매크로를 명시적으로 가져옴   |


```rust
use your_crate_name::approx_f64;

fn main() {
    assert!(approx_f64!(0.1 + 0.2, 0.3, 1e-9));
}
```

### 🔎 #[macro_use] extern crate ...;는 Rust 2015 스타일로, 지금은 명시적 use 방식이 권장돼요

## ⚠️ 주의 요약
| 항목               | 설명                                                                 |
|----------------------------|----------------------------------------------------------------------|
| `#[macro_export]`          | 매크로를 크레이트 루트에 등록하여 외부에서 사용할 수 있게 함          |
| `mod macros;`              | 반드시 `lib.rs` 또는 `main.rs`에서 선언해야 루트 등록이 작동함         |
| `pub use` 불가             | `macro_rules!` 매크로는 `pub use`로 재수출할 수 없음                  |

---


